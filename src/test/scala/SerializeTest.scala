import akka.util.ByteString
import com.karasiq.shadowcloud.index.diffs.IndexDiff
import com.karasiq.shadowcloud.index.{Chunk, File, Folder}
import com.karasiq.shadowcloud.serialization.SerializationModule
import org.scalatest.{FlatSpec, Matchers}

import scala.language.postfixOps

class SerializeTest extends FlatSpec with Matchers {
  val kryo = SerializationModule.kryo

  "Kryo serializer" should "serialize chunk" in {
    val chunk = TestUtils.randomChunk
    val bytes = kryo.toBytes(chunk)
    kryo.fromBytes[Chunk](bytes) shouldBe chunk
  }

  it should "serialize file" in {
    val file = TestUtils.randomFile()
    val bytes = kryo.toBytes(file)
    kryo.fromBytes[File](bytes) shouldBe file
  }

  it should "serialize folder" in {
    val folder = TestUtils.randomFolder()
    val bytes = kryo.toBytes(folder)
    kryo.fromBytes[Folder](bytes) shouldBe folder
  }

  it should "serialize diff" in {
    val diff = TestUtils.randomDiff
    val bytes = kryo.toBytes(diff)
    kryo.fromBytes[IndexDiff](bytes) shouldBe diff
  }

  it should "read test diff" in {
    import TestUtils.ByteStringObjOps
    val diff = TestUtils.testDiff
    val bytes =
      """01630101007363616c612e636f6c6c656374696f6e2e696d6d757461626c652e53657424456d707479536574
        |a401180104610160010101616b6b612e7574696c2e42797465537472696e672442797465537472696e6731c3
        |0114f660847d03634f41c45f7be337b02973a083721ac8010101086c0101534841b1c80164010102616b6b61
        |2e7574696c2e42797465537472696e672442797465537472696e67b10164596f75206d61792068617665206e
        |6f746963656420766172696f757320636f6465207061747465726e73207468617420656d6572676520776865
        |6e2074657374696e672073747265616d20706970656c696e65732e20416b6b612053747265616d2068610102
        |0164596f75206d61792068617665206e6f746963656420766172696f757320636f6465207061747465726e73
        |207468617420656d65726765207768656e2074657374696e672073747265616d20706970656c696e65732e20
        |416b6b612053747265616d2068616d010101010001010f6f016101600101010114dfa6cbe4eb725d390e3339
        |075fe420791a5a394fc8010101136c09c80164010102016473206120736570617261746520616b6b612d7374
        |7265616d2d746573746b6974206d6f64756c6520746861742070726f766964657320746f6f6c732073706563
        |69666963616c6c7920666f722077726974696e672073747265616d2074657374732e20540102016473206120
        |736570617261746520616b6b612d73747265616d2d746573746b6974206d6f64756c6520746861742070726f
        |766964657320746f6f6c73207370656369666963616c6c7920666f722077726974696e672073747265616d20
        |74657374732e20546d0e6101600101010114e63bf72054623e911ce6a995dc520527d7fe2e2dc8010101196c
        |09c801640101020164686973206d6f64756c6520636f6d657320776974682074776f206d61696e20636f6d70
        |6f6e656e74732074686174206172652054657374536f7572636520616e64205465737453696e6b2077686963
        |682070726f7669646520736f757263657320616e6401020164686973206d6f64756c6520636f6d6573207769
        |74682074776f206d61696e20636f6d706f6e656e74732074686174206172652054657374536f757263652061
        |6e64205465737453696e6b2077686963682070726f7669646520736f757263657320616e646d0e6101600101
        |010114802f6e7f54ca13c650741e65f188b0bdb023cb157001011f6c09706401010201382073696e6b732074
        |686174206d6174657269616c697a6520746f2070726f626573207468617420616c6c6f7720666c75656e7420
        |4150492e010201382073696e6b732074686174206d6174657269616c697a6520746f2070726f626573207468
        |617420616c6c6f7720666c75656e74204150492e6d0e01037363616c612e636f6c6c656374696f6e2e696d6d
        |757461626c652e24636f6c6f6e24636f6c6fee0101670101000401000415010165016001010101142f5a0c41
        |9cfeb92f05888ae3468e54fee3ee1726c8050101286c09c80501030104610661116117611ddaf9fab2c656da
        |f9fab2c65601746573742e7478f46a0101047363616c612e636f6c6c656374696f6e2e696d6d757461626c65
        |2e4e696ca401000100046a2bdaf9fab2c656daf9fab2c656""".stripMargin.lines.mkString
    kryo.fromBytes[IndexDiff](ByteString.fromHexString(bytes)) shouldBe diff
  }
}
